on: push

jobs:

  code-format-c-cpp:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install required packages
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends git clang-format
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
      - name: Run clang-format
        run: |
          ret=0
          while read f; do
            clang-format "$f" | diff -u "$f" - || ret=1
          done <<<"$(git ls-files \*.cpp \*.h \*.hpp)"
          exit "$ret"

  code-format-py:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: 3.7
      - name: Install autopep8
        run: pip3 install autopep8
      - name: Run autopep8
        run: git ls-files \*.py | xargs autopep8 --diff --exit-code

  run-tests:
    runs-on: ubuntu-latest
    container: debian:buster
    steps:
      - uses: actions/checkout@v2
      - name: Install required packages
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          apt-get install -y --no-install-recommends build-essential pkg-config cmake libblas-dev libopenblas-dev libatlas-base-dev
          apt-get clean
          rm -rf /var/lib/apt/lists/*
      - name: Build tests
        run: |
          mkdir build/
          cd build/
          cmake .. -DBUILD_TESTING=TRUE -DNO_QMKL6=TRUE
          make
      - name: Run tests
        run: |
          tail -n +1 /proc/cpuinfo /proc/meminfo
          echo
          cd build/
          ctest -V
